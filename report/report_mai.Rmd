---
title: "Report Mai 2022"
author: "Lucas Wei√ü"
date: "5/2/2022"

output: 
  html_document:
    css: "style.css"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

# load packages -------------------------------------------------------------------------------

library(data.table)
library(dtplyr)
library(tidyverse)
library(caret)
```

# Bavaria 

```{r}
load(file="../output/ranger_single_BV1.RData")
load(file="../output/freq_plot_2020_BV.Rdata")
```

### Model Setup

The current model includes all data points from Bavaria.
The data cleaning process however removed a big part of the data. Namely all the plots where the crop type was not available, grassland, mixed or otherwise without price data attached. 
The training data set includes all the years from 2005 up until 2019. The testing was done on the year 2020.

Here we see the accuracy and the kappa value for the current model.

<div class="acc">
<table>
<tr>
<td>Accuracy</th>
<td>Kappa</th>
</tr>
<tr>
<td>0.6511337</th>
<td>0.5900798</th>    
</tr>
</table>
</div>

<br>

### Predictions per Crop Type

When we take a look at the predictions per class we see that the model really prefers to predict the crop types 2 3 and 5.
These include:

<div class="ctype">
<table>
<tr>
<td>2</th>
<td>3</th>
<td>4</th>
</tr>
<tr>
<td>Maize</th>
<td>Wheat</th>
<td>Barley</th>
</tr>
</table>
</div>

<br>

Comparing this result with the distribution of crop types within the data, we can see a pattern. The representation of crop type frequency and prediction goes in the same direction.

```{r}
plot(res$predictions, las = 2, main="Number of predictions per Class")
(ctype_by_year_plot)+
  labs(x="Crop Type", y="Count")

```

The heatmap shows the expected diagonal for some crop types, but not all of them. 
For the crop types 2,3 and 4 there is a bit of confusion going on, but these are the most common crop types anyways. 

```{r}
hmap
```

The heatmap of the trainig data shows as expected the diagonal line.
```{r}
hmap_train
```

### Variable Importance 

Taking a look at variable importance, we see that the x and y coordinates are a huge predictor.


```{r}
var_importance <- res$variable.importance
barplot(var_importance[order(var_importance, decreasing = TRUE)], las = 2, main="Variable importance")
```

<br>
<div class="parameter">
<table>
  <tr>
    <th>Parameter</th>
    <th>Description</th>
  </tr>
  <tr>
    <td>X, Y </td>
    <td>X and Y coordinates</td>
  </tr>
  <tr>
    <td>PCType, PPCType </td>
    <td>Crop type from the year before and crop type from 2 years before</td>
  </tr>
  <tr>
    <td>SElev, SSlope, SType </td>
    <td>Elevation, Slope and soil type</td>
  </tr>
  <tr>
    <td>TempAVG, TempJJ, TempAM     </td>
    <td>Temperature average over the summer, for the summer months and spring</td>
  </tr>
  <tr>
    <td>RadAVG, RadJJ, RadAM </td>
    <td>Radiation average over the summer, for the summer months and spring</td>
  </tr>
  <tr>
    <td>PrecAVG, PrecJJ, PrecAM </td>
    <td>Precipitation average over the summer, for the summer months and spring</td>
  </tr>
  <tr>
    <td>pprice</td>
    <td>Price of previous years crop</td>
  </tr>
  <tr>
    <td>lyprice</td>
    <td>Last years price of this years crop</td>
  </tr>
  <tr>
    <td>deltaPrice</td>
    <td>Difference of this years crop last years price to the year before</td>
  </tr>
  <tr>
    <td>State</td>
    <td>State were in</td>
  </tr>
  <tr>
    <td>Year</td>
    <td>Years</td>
  </tr>
</table>
<br>


### Accuracy for each Crop Type

In the next figure, we can see the different accuracy for each crop type.


```{r}
ggplot(data=class_accuracy, aes(x=pred.predictions, y=acc)) +
  geom_bar(stat="identity")+
  ggtitle("Accuracy for each class")+
  labs(x="Crop Type", y="Accuracy")
```

# The same for 3 year test model

The training data set includes all the years from 2005 up until 2017. The test data set is all the data in the year 2018, 2019 and 2020.


```{r}
load(file="../output/ranger_single_BV3.RData")
load(file="../output/freq_plot_3year_BV.Rdata")
```
<div class="acc">
<table>
<tr>
<td>Accuracy</th>
<td>Kappa</th>
</tr>
<tr>
<td>0.4904</th>
<td>0.2838</th>    
</tr>
</table>
</div>

<br>
```{r}
plot(res$predictions, las = 2, main="Number of predictions per Class")
(ctype_by_year_plot)+
  labs(x="Crop Type", y="Count")

```

```{r}
hmap
```

```{r }
hmap_train
```

```{r }
var_importance <- res$variable.importance
barplot(var_importance[order(var_importance, decreasing = TRUE)], las = 2, main="Variable importance")
```

```{r}
ggplot(data=class_accuracy, aes(x=pred.predictions, y=acc)) +
  geom_bar(stat="identity")+
  ggtitle("Accuracy for each class")+
  labs(x="Crop Type", y="Accuracy")
```